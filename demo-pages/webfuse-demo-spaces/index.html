<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Iconify (for any icons used by your widget) -->
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

  <!-- Demo Link Generator widget -->
  <script type="module" src="widget/demo-url-widget.js"></script>
  <link rel="stylesheet" href="widget/demo-url-widget.css">

  <title>Sales Team Demo Spaces</title>

  <style>
    :root{
      --bg:#0b0d12;
      --bg-soft:#11141b;
      --panel:#141826;
      --panel-hi:#1a2030;           /* slightly lighter panel for readability */
      --panel-card:rgba(255,255,255,.08); /* lighter card layer */
      --ink:#e7ecf5;
      --ink-dim:#bfc6d1;            /* a bit brighter than before */
      --brand:#7c5cff;
      --brand-2:#24c7d6;
      --accent:#00e5a8;
      --border:rgba(255,255,255,.14);/* slightly stronger border */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --maxw:1280px;
      --divider:rgba(255,255,255,.10);
      --h-card:18px;                /* title size (matches widget's .duh-title) */
      --h-section:22px;             /* Use Case / ICP / Setup / HowTo */
    }

    *{ box-sizing:border-box }

    html, body{ height:100% }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.22), transparent 60%),
        radial-gradient(1000px 600px at 110% 10%, rgba(36,199,214,.16), transparent 60%),
        var(--bg);
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    a{ color:var(--brand-2); text-decoration:none }

    .wrap{ max-width:var(--maxw); margin:0 auto; padding:0 28px }

    header{ position:relative; padding:84px 0 8px; } /* extra top space */

    h1{
      font-size: clamp(36px, 4vw, 48px);
      line-height:1.15; margin:20px 0; text-align:center;
    }

    .gradient-ink{
      background:linear-gradient(90deg, var(--brand), var(--brand-2));
      -webkit-background-clip:text; background-clip:text;
      -webkit-text-fill-color:transparent; color:transparent;
    }

    .hint{ text-align:center; color:var(--ink-dim); font-size:14px; margin:8px 0 0 }

    main.wrap{ padding:18px 28px 48px }

    /* ---------- Collapsible sections (details/summary) ---------- */
    details.entry{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, var(--panel-card), rgba(255,255,255,.04)),
        var(--panel-hi);
      box-shadow: var(--shadow);
      margin: 26px 0;
      position: relative;
    }
    details.entry::before, details.entry::after{
      content:""; display:block; height:1px; background:var(--divider);
      position:absolute; left:10px; right:10px;
    }
    details.entry::before{ top:-12px }
    details.entry::after{ bottom:-12px }

    summary.titlebar{
      display:grid; grid-template-columns: 1fr auto; gap:12px;
      align-items:center; padding:16px 20px; cursor:pointer; list-style:none;
    }
    summary.titlebar::-webkit-details-marker{ display:none; }

    .title{
      font-weight:800; font-size: var(--h-card); color:#fff; /* match widget title */
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .embed-slot{
      display:flex; align-items:center; justify-content:flex-end; min-height:35px;
    }

    .content-pad{ padding: 0 20px 18px; }

    /* ---------- Section cards (lighter for readability) ---------- */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      margin-top:16px;
    }

    /* Section headings (Use Case / ICP / Setup / How to Demo) */
    .section-heading{
      margin:0 0 10px;
      color:#fff;                 /* white (same as widget title color) */
      font-weight:900;
      font-size: var(--h-section);
      letter-spacing:.2px;
      text-align:center;          /* centered per request */
    }
    /* Make Use Case a bit larger than the base section size */
    .section-heading.usecase{ font-size: calc(var(--h-section) + 2px); }

    /* Bolder content for Use Case & ICP */
    .bold-content :where(p, li){ font-weight:650; font-size:1.02rem; line-height:1.7; color:#fff; }
    .bold-content :where(ul,ol){ margin:10px 0 10px 20px; }

    /* Two-up layout for Setup + How to Demo */
    .two-col{
      display:grid; gap:16px; grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 920px){
      .two-col{ grid-template-columns: 1fr; }
    }

    /* Purple ordered list numbers */
    .card ol{ counter-reset: step; margin: 10px 0 0 22px; }
    .card ol li{ margin:.45rem 0; line-height:1.6; }
    .card ol li::marker{ color: var(--brand); font-weight:800; }

    /* Markdown base text inside normal (non-bold) areas */
    .card :where(p, li){ color:var(--ink); font-size:1rem; line-height:1.7; }
    .card :where(ul,ol){ margin:8px 0 10px 20px; padding:0; }
    .card li+li{ margin-top:4px; }
    .card a{ text-decoration: underline; }

    .kbd, code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:.95rem; color:#cfe1ff;
      background: linear-gradient(180deg, rgba(124,92,255,.22), rgba(36,199,214,.12)), #0f1330;
      border:1px solid rgba(124,92,255,.45);
      padding:.18rem .42rem; border-radius:6px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }

    /* Gentle glow for embedded button iframes */
    .embed-slot iframe{
      border-radius:10px; border:1px solid var(--ink-dim);
      box-shadow:0 0 0 0 rgba(255,255,255,.18);
      animation:pulseGlow 2.8s ease-in-out infinite;
    }
    .embed-slot> :first-child{ border-radius:10px; height:28px; }

    @keyframes pulseGlow{
      0%,100%{ box-shadow:0 0 0 0 rgba(255,255,255,.18); }
      50%{ box-shadow:0 0 16px 6px rgba(255,255,255,.14); }
    }
    @media (prefers-reduced-motion: reduce){
      .embed-slot iframe{ animation:none; }
    }

    /* Media */
    .media-card{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid var(--border); border-radius: var(--radius);
      padding:18px; box-shadow: var(--shadow); margin-top:16px; }
    .media-wrap{ border:1px solid var(--border); border-radius:12px; background:#0f1422; padding:10px; }
    .media-wrap video, .media-wrap img{ display:block; width:100%; height:auto; border-radius:8px; }

    /* Collapsible caret indicator */
    .caret{
      display:inline-flex; align-items:center; justify-content:center;
      width:26px; height:26px; border-radius:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      margin-left:10px; font-size:12px; color:#fff;
      transition: transform .15s ease;
    }
    details[open] .caret{ transform: rotate(90deg); }

    /* Collapsible: Demo Link Generator container */
    .widget-wrap{
      border:1px solid var(--border); border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      margin: 16px 0 22px;
    }
    .widget-summary{
      display:flex; align-items:center; gap:10px; cursor:pointer;
      padding:14px 16px; list-style:none; color:#fff; font-weight:800; font-size: var(--h-card);
    }
    .widget-summary::-webkit-details-marker{ display:none; }

    .loading, .error{ color:var(--ink-dim); font-size:14px; padding:10px 0 }
    .error{ color:#ff6b6b }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <header class="wrap">
    <h1><span class="gradient-ink">Sales Team:</span> Demo Space Portal</h1>
    <p class="hint">Import & configure pre-built Webfuse demos</p>
  </header>

  <main class="wrap">

    <!-- Collapsible Demo Link Generator -->
    <details class="widget-wrap" open>
      <summary class="widget-summary">
        <span>Demo Link Generator</span>
        <span class="caret">▶</span>
      </summary>
      <div style="padding: 0 16px 14px;">
        <div id="demo-url-helper"></div>
      </div>
    </details>

    <div id="status" class="loading">Loading demo spaces…</div>
    <div id="entries"></div>
  </main>

  <script>
    const IS_PAGES = location.hostname === "demo.surfly.com";
    const GITHUB_OWNER  = IS_PAGES ? "" : "JSPOON3R";
    const GITHUB_REPO   = IS_PAGES ? "" : "JSPOON3R.github.io";
    const GITHUB_BRANCH = "main";
    const BASE_PATH     = "demo-pages/webfuse-demo-spaces";

    // Helpers
    const esc = (s) => (s || "").replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    const ghApiUrl = (path) =>
      `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(GITHUB_BRANCH)}`;
    const ghRawUrl = (path) =>
      `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${encodeURIComponent(GITHUB_BRANCH)}/${path}`;

    // Try to fetch a file; return the absolute URL if it exists, else null
    async function resolveIfExists(path){
      try{
        const r = await fetch(encodeURI(path), { method:'GET' });
        if (r.ok) return path;
      }catch{}
      return null;
    }

    // Look for media in /src/ (now includes recording.mp4 explicitly)
    async function findSpaceMedia(entryRoot){
      const candidates = [
        `${entryRoot}/src/recording.mp4`,
        `${entryRoot}/src/demo.mp4`,
        `${entryRoot}/src/overview.mp4`,
        `${entryRoot}/src/teaser.mp4`,
        `${entryRoot}/src/preview.webm`,
        `${entryRoot}/src/demo.mov`,
        `${entryRoot}/src/overview.mov`,
        `${entryRoot}/src/teaser.mov`,
        `${entryRoot}/src/preview.gif`,
        `${entryRoot}/src/preview.png`,
        `${entryRoot}/src/preview.jpg`,
      ];
      for (const p of candidates){
        const hit = await resolveIfExists(p);
        if (hit) return hit;
      }
      return null;
    }

    function renderMediaHTML(url){
      const ext = (url.split('.').pop() || '').toLowerCase();
      if (['mp4','webm','mov'].includes(ext)){
        const mime = ext === 'webm' ? 'video/webm' : 'video/mp4';
        return `
          <div class="media-card">
            <div class="media-wrap">
              <video controls preload="metadata" playsinline>
                <source src="${url}" type="${mime}">
                Your browser can’t play this video. <a href="${url}" target="_blank" rel="noopener">Download</a>.
              </video>
            </div>
          </div>
        `;
      }
      return `
        <div class="media-card">
          <div class="media-wrap"><img src="${url}" alt="Demo preview"></div>
        </div>
      `;
    }

    /* ---------- Parse info markdown (Use Case & ICP only) ---------- */
    function parseInfoMarkdown(md){
      const out = { useCase:"", icp:"", useBullets:[], icpBullets:[] };
      if (!md) return out;
      const lines = md.split(/\r?\n/);
      let section = "use";
      for (const line of lines){
        if (/^\s*#{1,6}\s*Use\s*Case\b/i.test(line)) { section = "use"; continue; }
        if (/^\s*#{1,6}\s*ICP\b/i.test(line))       { section = "icp"; continue; }

        const bullet = line.match(/^\s*[-*]\s+(.*)$/)?.[1];
        if (bullet){
          if (section === "use") out.useBullets.push(bullet.trim());
          else if (section === "icp") out.icpBullets.push(bullet.trim());
        }else{
          if (section === "use") out.useCase += line + "\n";
          else if (section === "icp") out.icp += line + "\n";
        }
      }
      out.useCase = out.useCase.trim();
      out.icp     = out.icp.trim();
      return out;
    }

    /* ---------- Split instructions into Setup & How to Demo ---------- */
    function splitInstructions(md){
      if (!md) return { setupHtml:"", demoHtml:"" };
      const parts = md.split(/\r?\n(?=##\s+)/);
      let setup="", demo="";
      for (const block of parts){
        if (/^##\s*Set\s*Up\b/i.test(block))     setup = block;
        if (/^##\s*How\s*to\s*Demo\b/i.test(block)) demo = block;
      }
      return {
        setupHtml: setup ? marked.parse(setup) : "",
        demoHtml:  demo  ? marked.parse(demo)  : ""
      };
    }

    function paragraphize(text){
      const chunks=(text||"").trim().split(/\n{2,}/).map(s=>s.trim()).filter(Boolean);
      return chunks.length ? chunks : (text ? [text] : []);
    }

    function renderParagraphBlock(textArray, extraClasses=""){
      // Render markdown paragraphs as a simple block (not the old three-up).
      const html = textArray.map(t => `<p>${esc(t)}</p>`).join("");
      return `<div class="${extraClasses}">${html}</div>`;
    }

    /* ---------- Render one entry (as collapsible details) ---------- */
    async function renderEntry(entryName){
      const entryRoot = `${BASE_PATH}/Spaces/${entryName}`;

      async function fetchText(path){
        if (GITHUB_OWNER && GITHUB_REPO){
          const api = ghApiUrl(path);
          const r = await fetch(api);
          if (!r.ok) throw new Error(`Failed to fetch ${path} from GitHub API`);
          const j = await r.json();
          if (j && j.encoding === "base64" && typeof j.content === "string"){
            return atob(j.content.replace(/\n/g,""));
          }
          const r2 = await fetch(ghRawUrl(path));
          if (!r2.ok) throw new Error(`Failed to fetch raw ${path}`);
          return await r2.text();
        }
        const rel = path.replace(`${BASE_PATH}/`,"");
        const r = await fetch(encodeURI(rel));
        if (!r.ok) throw new Error(`Failed to fetch ${rel}`);
        return await r.text();
      }

      // Load markdown + embed
      let infoMd="", instructionsMd="", iframeHtml="";
      try{ infoMd        = await fetchText(`${entryRoot}/demo-space-info.md`); } catch(e){ console.warn('info md fetch failed:', e); }
      try{ instructionsMd= await fetchText(`${entryRoot}/instructions.md`);   } catch(e){ console.warn('instructions md fetch failed:', e); }
      try{ iframeHtml    = await fetchText(`${entryRoot}/embed.html`);        } catch(e){ /* optional */ }

      const { useCase, icp, useBullets, icpBullets } = parseInfoMarkdown(infoMd);
      const { setupHtml, demoHtml } = splitInstructions(instructionsMd);

      const title = entryName.replace(/[-_]/g," ");

      const mediaUrl  = await findSpaceMedia(entryRoot);
      const mediaHtml = mediaUrl ? renderMediaHTML(mediaUrl) : "";

      const useBlock = renderParagraphBlock(useBullets.length ? useBullets : paragraphize(useCase), "bold-content");
      const icpBlock = renderParagraphBlock(icpBullets.length ? icpBullets : paragraphize(icp), "bold-content");

      const node = document.createElement("details");
      node.className = "entry";
      node.open = false; // start collapsed

      node.innerHTML = `
        <summary class="titlebar">
          <div class="title">${esc(title)}</div>
          <div class="embed-slot">
            ${iframeHtml ? iframeHtml : '<div class="hint">Add <span class="kbd">embed.html</span> to show a button</div>'}
            <span class="caret">▶</span>
          </div>
        </summary>

        <div class="content-pad">
          ${mediaHtml}

          <div class="card">
            <h3 class="section-heading usecase">Use Case</h3>
            ${useBlock}
          </div>

          <div class="card">
            <h3 class="section-heading">ICP</h3>
            ${icpBlock}
          </div>

          <div class="two-col">
            <div class="card">
              <h3 class="section-heading">Set Up</h3>
              ${marked.parse(setupHtml || "_(missing **## Set Up** in instructions.md)_")}
            </div>
            <div class="card">
              <h3 class="section-heading">How to Demo</h3>
              ${marked.parse(demoHtml || "_(missing **## How to Demo** in instructions.md)_")}
            </div>
          </div>
        </div>
      `;
      return node;
    }

    /* ---------- Discover entries ---------- */
    async function discoverEntries(){
      const status = document.getElementById("status");
      const entriesHost = document.getElementById("entries");
      try{
        let folders = [];

        if (GITHUB_OWNER && GITHUB_REPO){
          const api = ghApiUrl(`${BASE_PATH}/Spaces`);
          const r = await fetch(api);
          if (r.ok){
            const list = await r.json();
            folders = (Array.isArray(list) ? list : []).filter(x => x.type === "dir").map(x => x.name);
          }else{
            throw new Error("GitHub API listing failed");
          }
        }else{
          try{
            const r = await fetch("Spaces/index.json");
            if (r.ok){
              const j = await r.json();
              folders = Array.isArray(j.folders) ? j.folders : [];
            }
          }catch{}
          if (folders.length === 0) folders = ["Webfuse-Workspace-Import"];
        }

        status.remove();

        for (const folder of folders){
          try{
            const node = await renderEntry(folder);
            entriesHost.appendChild(node);
          }catch(e){
            const err = document.createElement("div");
            err.className = "error";
            err.textContent = `Failed to load "${folder}": ${e.message}`;
            entriesHost.appendChild(err);
          }
        }
      }catch(e){
        status.className = "error";
        status.textContent = "Failed to load spaces: " + e.message;
      }
    }
    discoverEntries();
  </script>
</body>
</html>