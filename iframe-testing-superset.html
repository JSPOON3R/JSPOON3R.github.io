<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iframe Loader + XFO/CSP Diagnostics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0d12;
      --card: #141923;
      --muted: #8892a6;
      --text: #e6e9ef;
      --good: #2ecc71;
      --warn: #f1c40f;
      --bad:  #e74c3c;
      --accent: #5b8cff;
      --border: #263042;
      --code: #0f1420;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0d12 0%, #0d1117 100%);
      color: var(--text);
    }
    header {
      padding: 24px 20px 8px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
      letter-spacing: .3px;
    }
    .sub { color: var(--muted); font-size: 14px }
    .container {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      padding: 16px 20px 24px;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: clip;
      box-shadow: 0 4px 24px rgba(0,0,0,.25);
    }
    .card > .head {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card > .body { padding: 14px }
    .row { display: flex; gap: 10px; align-items: center }
    input[type="text"] {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0e1420;
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input::placeholder { color: #5f6b82 }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button.ghost {
      background: transparent;
      border-color: var(--border);
      color: var(--text);
    }
    iframe {
      width: 100%;
      height: 60vh;
      border: none;
      background: #0b0d12;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0e1420;
      color: var(--text);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.4;
      white-space: pre;
    }
    .mono {
      background: var(--code);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      white-space: pre-wrap;
    }
    .kvs { width: 100%; border-collapse: collapse; font-size: 13px }
    .kvs th, .kvs td { padding: 8px 10px; border-bottom: 1px dashed var(--border); vertical-align: top }
    .kvs th { text-align: left; color: var(--muted); width: 220px; font-weight: 500 }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .ok { background: rgba(46, 204, 113, .15); color: var(--good); border: 1px solid rgba(46, 204, 113, .35) }
    .warn { background: rgba(241, 196, 15, .15); color: var(--warn); border: 1px solid rgba(241, 196, 15, .35) }
    .bad { background: rgba(231, 76, 60, .15); color: var(--bad); border: 1px solid rgba(231, 76, 60, .35) }
    details summary { cursor: pointer; color: var(--muted) }
    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr }
      iframe { height: 52vh }
    }
  </style>
</head>
<body>
  <header>
    <h1>Iframe Loader + Response Header Inspector</h1>
    <div class="sub">Type a URL and press Enter (or click Load). Paste <code>curl -I</code> output to analyze X-Frame-Options and CSP.</div>
  </header>

  <div class="container">
    <!-- Left: Iframe loader -->
    <section class="card">
      <div class="head">
        <form id="urlForm" class="row" style="flex:1">
          <input id="urlInput" type="text" placeholder="https://example.com" autocomplete="off" />
          <button type="submit" aria-label="Load URL">Load</button>
        </form>
        <button class="ghost" id="clearBtn" title="Clear iframe">Clear</button>
      </div>
      <div class="body">
        <iframe id="viewer" src="" referrerpolicy="strict-origin-when-cross-origin"></iframe>
        <div class="sub" style="margin-top:8px">
          Note: many sites block embedding via <code>X-Frame-Options</code> or <code>Content-Security-Policy: frame-ancestors</code>.
        </div>
      </div>
    </section>

    <!-- Right: diagnostics -->
    <section class="card">
      <div class="head">
        <div style="font-weight:600">Header Diagnostics</div>
        <div id="verdictPill" class="pill warn" style="margin-left:auto">Awaiting input…</div>
      </div>
      <div class="body grid">
        <textarea id="headersInput" spellcheck="false" placeholder="Paste `curl -I https://…` output here, then click Parse (or it will auto-parse)."></textarea>
        <div class="row" style="justify-content:flex-end; gap: 8px">
          <button id="loadSample" class="ghost" type="button">Load Sample</button>
          <button id="parseBtn" type="button">Parse</button>
        </div>
        <table class="kvs" id="kvTable" aria-label="Parsed headers"></table>
        <details>
          <summary>Show raw</summary>
          <div id="rawOut" class="mono" style="margin-top:8px"></div>
        </details>
      </div>
    </section>
  </div>

  <script>
    // --- IFrame Loader ---
    const form = document.getElementById('urlForm');
    const input = document.getElementById('urlInput');
    const iframe = document.getElementById('viewer');
    const clearBtn = document.getElementById('clearBtn');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      let url = (input.value || '').trim();
      if (!url) return;
      if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
      iframe.src = url;
    });
    clearBtn.addEventListener('click', () => {
      iframe.removeAttribute('src');
      input.focus();
    });

    // --- Header Parser ---
    const headersInput = document.getElementById('headersInput');
    const parseBtn = document.getElementById('parseBtn');
    const kvTable = document.getElementById('kvTable');
    const verdictPill = document.getElementById('verdictPill');
    const rawOut = document.getElementById('rawOut');
    const loadSample = document.getElementById('loadSample');

    const SAMPLE = `➜ ~ curl -I https://superset.surfly-dev.com/superset/explore/p/EmOwlYxgDxd/\\?standalone\\=1\\&height\\=400
HTTP/2 302
alt-svc: h3=":443"; ma=2592000
content-security-policy: base-uri 'self'; default-src 'self'; img-src 'self' blob: data: https://apachesuperset.gateway.scarf.sh https://static.scarf.sh/ ows.terrestris.de; worker-src 'self' blob:; connect-src 'self' https://api.mapbox.com https://events.mapbox.com; object-src 'none'; style-src 'self' 'unsafe-inline'; script-src 'self' 'strict-dynamic' 'nonce-yiVWUq_ws_JiDtpFwxH4CCG5UuS1iIEx'
content-type: text/html; charset=utf-8
date: Mon, 25 Aug 2025 13:55:21 GMT
location: /login/?next=http://superset.surfly-dev.com/superset/explore/p/EmOwlYxgDxd/?standalone%3D1%26height%3D400
permissions-policy: browsing-topics=()
referrer-policy: strict-origin-when-cross-origin
server: Werkzeug/3.1.3 Python/3.11.13
set-cookie: session=eyJfZmxhc2hlcyI6W3siIHQiOlsiZGFuZ2VyIiwiQWNjZXNzIGlzIERlbmllZCJdfV0sImxvY2FsZSI6ImVuIn0.aKxrSQ.Z4dSvXfhbnvLx24bMICKgs41khQ; HttpOnly; Path=/; SameSite=Lax
strict-transport-security: max-age=31556926; includeSubDomains
vary: Accept-Encoding, Cookie
via: 1.1 Caddy
x-content-type-options: nosniff
x-frame-options: SAMEORIGIN
content-length: 397`;

    loadSample.addEventListener('click', () => {
      headersInput.value = SAMPLE;
      parseHeaders();
      headersInput.focus();
    });

    parseBtn.addEventListener('click', parseHeaders);
    headersInput.addEventListener('input', () => {
      // light auto-parse on pauses
      clearTimeout(headersInput._t);
      headersInput._t = setTimeout(parseHeaders, 400);
    });

    function parseHeaders() {
      const raw = headersInput.value || '';
      rawOut.textContent = raw.trim();

      const lines = raw.split(/\r?\n/);
      let statusLine = '';
      const headers = {};
      for (const line of lines) {
        if (!line.trim()) continue;
        if (/^HTTP\/\d\.\d\s+/i.test(line) || /^HTTP\/2\s+/i.test(line)) {
          statusLine = line.trim();
          continue;
        }
        const m = line.match(/^([^:]+):\s*(.*)$/);
        if (m) {
          const k = m[1].toLowerCase().trim();
          const v = m[2].trim();
          if (!(k in headers)) headers[k] = v;
          else headers[k] += ', ' + v;
        }
      }

      // Build table rows
      const kv = [];
      function push(key, label) {
        const v = headers[key.toLowerCase()];
        if (v != null) kv.push([label || key, v]);
      }

      // Always show key framing-related headers prominently
      push('x-frame-options', 'X-Frame-Options');
      push('content-security-policy', 'Content-Security-Policy');
      push('location', 'Location');
      push('referrer-policy', 'Referrer-Policy');
      push('permissions-policy', 'Permissions-Policy');
      push('strict-transport-security', 'Strict-Transport-Security');
      push('x-content-type-options', 'X-Content-Type-Options');
      push('content-type', 'Content-Type');
      push('date', 'Date');
      push('server', 'Server');
      push('set-cookie', 'Set-Cookie');
      push('vary', 'Vary');
      push('via', 'Via');
      push('content-length', 'Content-Length');

      // Render table
      kvTable.innerHTML = `
        <thead>
          <tr><th>Header</th><th>Value</th></tr>
        </thead>
        <tbody>
          ${kv.map(([k, v]) => `<tr><th>${escapeHtml(k)}</th><td>${escapeHtml(v)}</td></tr>`).join('')}
        </tbody>
      `;

      // Compute verdict
      const verdict = computeVerdict(statusLine, headers);
      verdictPill.textContent = verdict.text;
      verdictPill.className = 'pill ' + verdict.className;
    }

    function computeVerdict(statusLine, headers) {
      const xfo = (headers['x-frame-options'] || '').toLowerCase();
      const csp = (headers['content-security-policy'] || '').toLowerCase();
      const loc = headers['location'] || '';
      const hasFrameAncestors = /(^|[\s;])frame-ancestors\s+/.test(csp);

      // Redirect awareness
      const isRedirect = /^http\/\d(?:\.\d)?\s+30\d/i.test(statusLine) || /^http\/2\s+30\d/i.test(statusLine);

      // Checks in priority order:
      if (xfo.includes('deny')) {
        return { text: 'Blocked: X-Frame-Options=DENY', className: 'bad' };
      }
      if (xfo.includes('sameorigin')) {
        return { text: 'Blocked (cross-origin): X-Frame-Options=SAMEORIGIN', className: 'bad' };
      }
      if (hasFrameAncestors) {
        // Try to extract the directive value for context
        const fa = (headers['content-security-policy'] || '')
          .match(/frame-ancestors\s+([^;]+)/i);
        const val = fa ? fa[1].trim() : '(present)';
        return { text: 'Controlled by CSP frame-ancestors: ' + val, className: 'warn' };
      }
      if (!hasFrameAncestors && !xfo) {
        // No explicit policy. Many browsers allow framing unless higher-level docs block it.
        return { text: isRedirect ? 'No XFO / no frame-ancestors (but redirects)' : 'No XFO / no frame-ancestors (likely frameable)', className: isRedirect ? 'warn' : 'ok' };
      }
      // Fallback
      return { text: 'Needs review', className: 'warn' };
    }

    function escapeHtml(s) {
      return (s ?? '').toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // Load the provided sample on first paint for convenience
    // (You can remove this if you prefer an empty textarea.)
    headersInput.value = '';
  </script>
</body>
</html>