<!DOCTYPE html>
<html>
<title>Surfly Demo</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="icon" href="https://capacity.com/wp-content/uploads/2019/08/favicon.ico" sizes="192x192" />
<script src="https://code.jquery.com/jquery-3.5.0.min.js"
    integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"
    integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
<style>
    body,
    h1 {
        font-family: "Raleway", sans-serif
    }

    body,
    html {
        height: 100%
    }

    .bgimg {
        background-image: url('https://capacity.com/wp-content/uploads/2021/09/2021-Homepage-Header-02.png');
        min-height: 100%;
        background-position: center;
        background-size: cover;
        background-color: #333;
        filter: blur(10px) brightness(0.5);
    }

    .color-white {
        color: white;
    }
</style>

<body>
    <script>
        var surflyLoaded = false;

        function loadScript(callback) {
            window.Surfly = window.Surfly || {
                init: function () {
                    window.Surfly.q = arguments
                }
            };
            const surflyScript = document.createElement('script');
            const mountingNode = document.body;

            surflyScript.async = false; // Set async to false to make it synchronous
            surflyScript.src = 'https://surfly.com/surfly.js';
            surflyScript.onload = function () {
                surflyLoaded = true;
                if (typeof callback === 'function') {
                    callback(); // Call the callback function if provided
                }
            };
            mountingNode.appendChild(surflyScript);
        }

        function surflyInit(callback) {
            const settings = {
                widget_key: '144b60c81b0446cfb3b4549c9d9f425e',
                require_password: false,
                session_autorestore_enabled: true
            };
            Surfly.init(settings, function (init) {
                if (!init.success) {
                    console.error('COBROWSE:INIT:INIT:FAILED');
                    return;
                }
                if (init.success) {
                    console.log('COBROWSE:INIT:INIT:SUCCESS');
                    if (typeof callback === 'function') {
                        callback(); // Call the callback function if provided
                    }
                }
            });
        }

        function startNew() {
            if (!window.Surfly) {
                console.error('COBROWSE:SCRIPT:SCRIPT_NOT_YET_LOADED');
                return;
            }
            Surfly.session()
                .on('session_started', (session) => {
                    console.log('COBROWSE:SESSION_EVENT:ESTABLISH_SESSION:DONE', {
                        link: session.followerLink,
                        pin: session.pin
                    })
                    console.log("new session: ", Surfly.currentSession);
                })
                .on('session_ended', () => {
                    console.log('COBROWSE:SESSION_EVENT:END_SESSION:DONE')
                })
                .on('session_loaded', () => {
                    console.log('COBROWSE:SESSION_EVENT:LOAD_SESSION:DONE')
                })
                .startLeader()
        }

        function buttonClick() {
            if (surflyLoaded) {
                if (!window.Surfly) {
                    console.error('COBROWSE:SCRIPT:SCRIPT_LOAD_FAILED');
                    return;
                }
                if (Surfly._allSessions.length === 0) {
                    console.log('COBROWSE:SCRIPT:NOT_IN_SESSION');
                    surflyInit(startNew); // Pass startNew function as callback
                } else {
                    console.log('COBROWSE:SCRIPT:EXISTING_SESSION(S)_FOUND');
                    // Init will automatically restore an existing session
                    surflyInit();
                    Surfly.on('session_restored', (api, event) => {
                        console.log('COBROWSE:GLOBAL_EVENT:RESTORE_SESSION:DONE', api, event)
                        console.log('COBROWSE:SCRIPT:SESSION_RESTORED: ', session.followerLink)
                    });
                }
            } else {
                console.error('COBROWSE:SCRIPT:SCRIPT_NOT_YET_LOADED');
            }
        }

        // Call loadScript to start loading the Surfly script
        loadScript();
    </script>

    <div class="bgimg w3-display-container w3-animate-opacity w3-text-white">
    </div>
    <div class="w3-display-middle color-white" style="text-align: center;">
        <h1 class="w3-jumbo w3-animate-top">Cobrowse Demo</h1>
        <hr class="w3-border-grey" style="margin:auto;width:40%">
        <p id="button-display" class="w3-large w3-center"><button type="button" onclick="buttonClick()">Start
                Cobrowse</button></p>
    </div>
    <div class="w3-display-bottomleft w3-padding-large color-white">
        Surfly script trial
    </div>
</body>

</html>